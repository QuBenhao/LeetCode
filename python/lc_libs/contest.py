import ast
import json
import os
import re
import time
import html
from bs4 import BeautifulSoup
from markdownify import markdownify as md

import dotenv
import requests


def get_contest_info(contest_id: str, cookie: str):
    url = f"https://leetcode.cn/contest/api/info/{contest_id}/"
    resp = requests.get(url, timeout=5, cookies={"LEETCODE_SESSION": cookie})
    """
    {"contest":{"id":1188,"title":"ç¬¬ 155 åœºåŒå‘¨èµ›","title_slug":"biweekly-contest-155","description":"<div>\n  <style>\n    .contest-information ol:not(.list-group) {\n      padding-left: 20px;\n    }\n\n    .contest-information ul:not(.list-group) {\n      padding-left: 20px;\n    }\n\n    .contest-information li:not(.list-group-item) {\n      margin-top: 5px;\n    }\n\n    .contest-information .list-group .list-group-item {\n      border: none;\n      margin-bottom: 1px;\n      display: flex;\n      flex-direction: row;\n      justify-content: space-between;\n    }\n\n    .contest-information .list-group .list-group-item > span {\n      flex: 0 0 auto;\n    }\n\n    .contest-information img[alt='LeetCoin'] {\n      position: relative;\n      top: -2px;\n    }\n\n    .contest-information .award-img {\n      display: block;\n      max-width: 600px;\n      width: 100%;\n      border-radius: 4px;\n    }\n\n    .contest-information .inner-banner {\n      margin: 30px 0 50px;\n      display: block;\n      max-width: 100%;\n      border-radius: 8px;\n    }\n\n    .contest-information ol p {\n      margin-top: 1em;\n      margin-bottom: 0.6em;\n    }\n\n    .contest-information ol {\n      list-style: auto;\n    }\n    .contest-information ul {\n      list-style: circle;\n    }\n  </style>\n\n  <div class=\"contest-information container\">\n    <div>\n      <div class=\"col-sm-8 col-md-9\">\n        <h3 class=\"text-300\">æ¬¢è¿æ¥åˆ°ç¬¬ 155 åœºåŒå‘¨èµ›</h3>\n        <br />\n        <p>\n          <strong>ã€æœ¬åœºå¥–åŠ±ã€‘</strong>\n        </p>\n\n        <ul>\n          <li><strong>æ’åç¬¬ 1 - 10 åçš„å‚èµ›è€…</strong> å¯è·åŠ›æ‰£ç”µè„‘åŒ… x1</li>\n          <li><strong>æ’åç¬¬ 55ã€155ã€1024ã€1337ã€2048 åçš„å‚èµ›è€…</strong> å¯è·ç›²ç›’å¥–åŠ± x1</li>\n        </ul>\n        <p style=\"border-color: var(--border-tertiary); border-left-width: 2px; padding-left: 1rem\">\n          <strong>æœ¬åœºç«èµ›å¥–å“å°†äºæ¯”èµ›å 20 ä¸ªå·¥ä½œæ—¥</strong>\n          å†…è¿›è¡Œå‘æ”¾ï¼Œå¦‚é‡ä¸å¯æŠ—åŠ›ç­‰æƒ…å†µï¼Œå¥–å“å¯èƒ½å»¶è¿Ÿå‘è´§æˆ–å‘ç”Ÿè°ƒæ¢ï¼Œè¯·å…³æ³¨åŠ›æ‰£å®˜æ–¹é€šçŸ¥ã€‚<br />\n        </p>\n\n        <img class=\"inner-banner\" src=\"https://pic.leetcode.cn/1699241059-loeyWv-1760-360%20%E5%A5%96%E5%93%81.png\" />\n      <h4 class=\"text-300\">\n        <i class=\"fa fa-newspaper-o\" style=\"color: #1DA09C\" aria-hidden=\"true\"></i>\n        &nbsp;é‡è¦æç¤º\n      </h4>\n        <ol>\n          <li>\n            åŠ›æ‰£ä¸€å‘éå¸¸é‡è§†ç«èµ›çš„å…¬å¹³å’Œå…¬æ­£ã€‚ä¸ºä¿éšœæ¯ä¸€ä½å‚èµ›è€…çš„æƒç›Šï¼Œç»™å¤§å®¶å¸¦æ¥æ›´å¥½çš„ç«èµ›ä½“éªŒï¼Œè¥é€ å¥åº·ç§¯æçš„ç«èµ›ç¯å¢ƒï¼Œæˆ‘ä»¬å¯¹ç«èµ›è§„åˆ™è¿›è¡Œäº†æ›´è¯¦ç»†çš„çº¦å®šå’Œè§„èŒƒï¼Œç‚¹å‡»\n            <a class=\"text-sd-info\" href=\"https://support.leetcode.cn/hc/kb/article/1278066/\" target=\"_blank\"\n              >æŸ¥çœ‹å…¨éƒ¨</a\n            >ã€‚\n          </li>\n          <li>è¯·æ³¨æ„ï¼Œæ¯ä¸ªé”™è¯¯æäº¤çš„æƒ©ç½šæ—¶é—´ä¸º <b>5 åˆ†é’Ÿ</b> ã€‚</li>\n          <li>\n            ä¸ºä¿éšœç«èµ›çš„å…¬å¹³æ€§ï¼ŒåŠ›æ‰£å°†åœ¨ç«èµ›ä¸­éšè—éƒ¨åˆ†ç”¨ä¾‹ã€‚å½“å‚èµ›è€…åœ¨ç«èµ›ä¸­æäº¤æœªé€šè¿‡æ—¶ï¼ŒåŠ›æ‰£ä¸ä¼šæ˜¾ç¤ºç»™å‚èµ›è€…è¢«éšè—çš„é”™è¯¯ç”¨ä¾‹ã€‚\n          </li>\n          <li>æœ¬åœºç«èµ›çš„æœ€ç»ˆæ’åä¼šåœ¨ç«èµ›ç»“æŸåçš„ 5 ä¸ªå·¥ä½œæ—¥å†…ç¡®è®¤ã€‚</li>\n          <li>\n            <b>ç«èµ›ä¸­çš„è¿è§„è¡Œä¸ºï¼š</b>\n            <ul>\n              <li>ä¸€äººä½¿ç”¨å¤šè´¦å·æäº¤ï¼ˆåŠ›æ‰£ã€Œä¸­æ–‡ç¤¾åŒº LCCNã€å’Œã€Œç¾å›½ç½‘ç«™ LCUSã€è´¦å·å±äºä¸¤ä¸ªè´¦å·ï¼‰</li>\n              <li>å¤šè´¦å·æäº¤é›·åŒä»£ç ï¼ˆæŠ„è¢­ï¼‰</li>\n              <li>ä½¿ç”¨ä¸æ­£å½“æ‰‹æ®µå½±å“ä»–äººç«èµ›çš„</li>\n              <li>ç«èµ›ç»“æŸå‰åœ¨è®¨è®ºåŒºå‘å¸ƒç­”æ¡ˆçš„</li>\n              <li>\n                ä¸¥ç¦ä½¿ç”¨ä»»ä½•ä»£ç ç”Ÿæˆå·¥å…·æˆ–è€…å¤–éƒ¨è¾…åŠ©æ‰‹æ®µè§£é¢˜ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºå°†é¢˜ç›®æè¿°ã€æµ‹è¯•ç”¨ä¾‹æˆ–è§£é¢˜ä»£ç è¾“å…¥åˆ°å¤–éƒ¨è¾…åŠ©å·¥å…·ä¸­çš„è¡Œä¸º\n              </li>\n            </ul>\n            <p>\n              å¦‚æœ‰ç”¨æˆ·è¢«æ£€æŸ¥å‡ºç«èµ›ä¸­å­˜åœ¨è¿è§„è¡Œä¸ºï¼ŒåŠ›æ‰£ä¼šåšæŒä»¥ ğŸ™… é›¶å®¹å¿ çš„æ€åº¦ç»´æŠ¤ç«èµ›çš„ âš–ï¸\n              å…¬å¹³ã€å…¬æ­£ï¼Œä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹å¤„ç½šè§„åˆ™æ‰§è¡Œï¼š\n            </p>\n            <ul>\n              <li>ç¬¬ä¸€æ¬¡è¿è§„ï¼šâ—ï¸ è´¦å·å†…çš„æ‰€æœ‰ç§¯åˆ†æ¸…é›¶ï¼Œè´¦å·å†»ç»“ 1 ä¸ªæœˆ</li>\n              <li>ç¬¬äºŒæ¬¡è¿è§„ï¼šğŸš« æ°¸ä¹…å°å·</li>\n            </ul>\n            <p>åŒæ—¶æˆ‘ä»¬ä¹Ÿé¼“åŠ±å¤§å®¶å…±åŒç»´æŠ¤ç«èµ›çš„å…¬å¹³å’Œå…¬æ­£ï¼Œæˆ‘ä»¬ä¼šç»™äºä¸¾æŠ¥æˆåŠŸçš„ç”¨æˆ·é¢å¤–çš„å¥–åŠ±ï¼š</p>\n            <ul>\n              <li>è¢«è®¤å®šä¸ºè¿è§„è´¦å·çš„å‰ 10 åä¸¾æŠ¥è€…ï¼Œæ¯äººå¯è·å¾— 20 ç§¯åˆ†å¥–åŠ±</li>\n              <li>æ¯äººæ¯åœºæœ€é«˜å¯è·å¾—ä¸¾æŠ¥æˆåŠŸçš„ 100 ç§¯åˆ†å¥–åŠ±</li>\n            </ul>\n          </li>\n          <p>\n            å¦å¤–ï¼Œä¸ºäº†ä¿è¯ç«èµ›çš„å…¬æ­£ã€å…¬å¹³ï¼Œè¯·å‹¿åœ¨ç«èµ›ç»“æŸå‰åœ¨è®¨è®ºåŒºå‘å¸ƒã€è®¨è®ºå¯èƒ½ä¼šå½±å“ç«èµ›æ­£å¸¸è¿›è¡Œçš„å†…å®¹ï¼ŒåŒ…æ‹¬ä¸”ä¸é™äºå‘å¸ƒç«èµ›é¢˜ç­”æ¡ˆã€è§£é¢˜æ€è·¯ã€æ–¹æ³•ã€æé†’æ³¨æ„ç­‰ï¼Œç¤¾åŒºç®¡ç†å‘˜å°†æœ‰æƒæ ¹æ®å®é™…æƒ…å†µäºˆä»¥è­¦å‘Šã€åˆ é™¤ã€ç¦è¨€ã€å°ç¦å…¶ç›¸åº”å¸å·çš„åŠŸèƒ½ï¼Œæƒ…èŠ‚ä¸¥é‡è€…ï¼Œå°†é…Œæƒ…å°ç¦å¯¹åº”\n            IPã€‚\n          </p>\n        </ol>\n        <br />\n        <br />\n      <h4 class=\"text-300\">\n        <i class=\"fa fa-bullhorn\" style=\"color: #FEA116\" aria-hidden=\"true\"></i>\n        &nbsp;é€šçŸ¥\n      </h4>\n        <p>\n          æ‚¨å¿…é¡»å…ˆ\n          <b class=\"text-sd-brand-lc-orange\">æŠ¥å</b> åæ–¹èƒ½å‚åŠ è¯¥åœºç«èµ›ã€‚æˆ‘ä»¬ç¥æ„¿æ‚¨å‚èµ›æ„‰å¿«ï¼\n        </p>\n        <br />\n\n        \n            <a href=\"/discuss/post/3662926/di-155-chang-shuang-zhou-sai-by-leetcode-0p0b\" target=\"_blank\">\n                <img\n                    src=\"https://assets.leetcode.cn/aliyun-lc-upload/contest-config/discuss/contest_to_discuss_image.png\"\n                    style=\"width:320px; border-radius: 10px; margin: 10px 0;\"\n                />\n            </a>\n        \n      </div>\n      <div class=\"col-sm-4 col-md-3\">\n      <h3 class=\"text-300\">\n        <i class=\"fa fa-trophy text-orange\" aria-hidden=\"true\"></i>\n        &nbsp;ç«èµ›å¥–åŠ±\n      </h3>\n        <ul class=\"list-group whitespace-nowrap\" style=\"margin-top: 20px; min-width: 250px\">\n          <li class=\"list-group-item\">\n            <b>ç¬¬ä¸€å</b>\n            <span>\n              5,000\n              <a href=\"/points/\" target=\"_blank\">\n                <img\n                  src=\"https://static.leetcode-cn.com/cn-legacy-assets/images/LeetCoin.png\"\n                  height=\"15px\"\n                  alt=\"LeetCoin\"\n                />\n              </a>\n            </span>\n          </li>\n          <li class=\"list-group-item\">\n            <b>ç¬¬äºŒå</b>\n            <span>\n              2,500\n              <a href=\"/points/\" target=\"_blank\">\n                <img\n                  src=\"https://static.leetcode-cn.com/cn-legacy-assets/images/LeetCoin.png\"\n                  height=\"15px\"\n                  alt=\"LeetCoin\"\n                />\n              </a>\n            </span>\n          </li>\n          <li class=\"list-group-item\">\n            <b>ç¬¬ä¸‰å</b>\n            <span>\n              1,500\n              <a href=\"/points/\" target=\"_blank\">\n                <img\n                  src=\"https://static.leetcode-cn.com/cn-legacy-assets/images/LeetCoin.png\"\n                  height=\"15px\"\n                  alt=\"LeetCoin\"\n                />\n              </a>\n            </span>\n          </li>\n          <li class=\"list-group-item\">\n            <b>4 - 10 å</b>\n            <span>\n              800\n              <a href=\"/points/\" target=\"_blank\">\n                <img\n                  src=\"https://static.leetcode-cn.com/cn-legacy-assets/images/LeetCoin.png\"\n                  height=\"15px\"\n                  alt=\"LeetCoin\"\n                />\n              </a>\n            </span>\n          </li>\n          <li class=\"list-group-item\">\n            <b>11 - 50 å</b>\n            <span>\n              300\n              <a href=\"/points/\" target=\"_blank\">\n                <img\n                  src=\"https://static.leetcode-cn.com/cn-legacy-assets/images/LeetCoin.png\"\n                  height=\"15px\"\n                  alt=\"LeetCoin\"\n                />\n              </a>\n            </span>\n          </li>\n          <li class=\"list-group-item\">\n            <b>51 - 100 å</b>\n            <span>\n              100\n              <a href=\"/points/\" target=\"_blank\">\n                <img\n                  src=\"https://static.leetcode-cn.com/cn-legacy-assets/images/LeetCoin.png\"\n                  height=\"15px\"\n                  alt=\"LeetCoin\"\n                />\n              </a>\n            </span>\n          </li>\n          <li class=\"list-group-item\">\n            <b>101 - 200 å</b>\n            <span>\n              50\n              <a href=\"/points/\" target=\"_blank\">\n                <img\n                  src=\"https://static.leetcode-cn.com/cn-legacy-assets/images/LeetCoin.png\"\n                  height=\"15px\"\n                  alt=\"LeetCoin\"\n                />\n              </a>\n            </span>\n          </li>\n          <li class=\"list-group-item\">\n            <b>é‡åœ¨å‚ä¸å¥–åŠ±</b>\n            <span>\n              5\n              <a href=\"/points/\" target=\"_blank\">\n                <img\n                  src=\"https://static.leetcode-cn.com/cn-legacy-assets/images/LeetCoin.png\"\n                  height=\"15px\"\n                  alt=\"LeetCoin\"\n                />\n              </a>\n            </span>\n          </li>\n          <li class=\"list-group-item\">\n            <b>é¦–æ¬¡å‚åŠ æ¯”èµ›å¹¶æˆåŠŸæäº¤</b>\n            <span>\n              200\n              <a href=\"/points/\" target=\"_blank\">\n                <img\n                  src=\"https://static.leetcode-cn.com/cn-legacy-assets/images/LeetCoin.png\"\n                  height=\"15px\"\n                  alt=\"LeetCoin\"\n                />\n              </a>\n            </span>\n          </li>\n          <li class=\"list-group-item\">\n            <b>ä¸€å‘¨åŒæ—¶å‚åŠ åŒå‘¨èµ›å’Œå‘¨èµ›</b>\n            <span>\n              66\n              <a href=\"/points/\" target=\"_blank\">\n                <img\n                  src=\"https://static.leetcode-cn.com/cn-legacy-assets/images/LeetCoin.png\"\n                  height=\"15px\"\n                  alt=\"LeetCoin\"\n                />\n              </a>\n            </span>\n          </li>\n        </ul>\n      <h4 class=\"text-300\">\n        <i class=\"fa fa-star text-yellow\" aria-hidden=\"true\"></i>\n        &nbsp;è¿½åŠ å¥–åŠ± - å…¨çƒæ’å\n      </h4>\n        <ul class=\"list-group whitespace-nowrap\" style=\"margin-top: 20px\">\n          <li class=\"list-group-item\">\n            <b>å…¨çƒæ’åå‰ 10</b>\n            <span>\n              500\n              <a href=\"/points/\" target=\"_blank\">\n                <img\n                  src=\"https://static.leetcode-cn.com/cn-legacy-assets/images/LeetCoin.png\"\n                  height=\"15px\"\n                  alt=\"LeetCoin\"\n                />\n              </a>\n            </span>\n          </li>\n          <li class=\"list-group-item\">\n            <b>å…¨çƒæ’å 11 - 20</b>\n            <span>\n              300\n              <a href=\"/points/\" target=\"_blank\">\n                <img\n                  src=\"https://static.leetcode-cn.com/cn-legacy-assets/images/LeetCoin.png\"\n                  height=\"15px\"\n                  alt=\"LeetCoin\"\n                />\n              </a>\n            </span>\n          </li>\n          <li class=\"list-group-item\">\n            <b>å…¨çƒæ’å 21 - 50</b>\n            <span>\n              100\n              <a href=\"/points/\" target=\"_blank\">\n                <img\n                  src=\"https://static.leetcode-cn.com/cn-legacy-assets/images/LeetCoin.png\"\n                  height=\"15px\"\n                  alt=\"LeetCoin\"\n                />\n              </a>\n            </span>\n          </li>\n          <li class=\"list-group-item\">\n            <b>å…¨çƒæ’å 51 - 100</b>\n            <span>\n              50\n              <a href=\"/points/\" target=\"_blank\">\n                <img\n                  src=\"https://static.leetcode-cn.com/cn-legacy-assets/images/LeetCoin.png\"\n                  height=\"15px\"\n                  alt=\"LeetCoin\"\n                />\n              </a>\n            </span>\n          </li>\n        </ul>\n      </div>\n    </div>\n  </div>\n  <hr />\n  <p>\n    <b\n      >æƒ³è®©åŠ›æ‰£ç¤¾åŒºçš„ç™¾ä¸‡æå®¢ä»¬ <i>è®¤è¯†æ‚¨çš„å…¬å¸</i> å—ï¼Ÿ é‚£å°±èµ¶å¿«\n      <a class=\"text-sd-info\" href=\"https://support.leetcode.cn/hc/request/new/\" target=\"_blank\">è”ç³»æˆ‘ä»¬</a>\n      ï¼Œå³æœ‰å¯èƒ½èµåŠ©æˆ‘ä»¬çš„ä¸‹ä¸€åœºç«èµ›å“¦ï¼</b\n    >\n  </p>\n</div>\n","duration":5400,"start_time":1747663571,"is_virtual":true,"origin_start_time":1745677800,"is_private":false,"related_contest_title":null,"is_ee_exam_contest":false,"card_img":"https://assets.leetcode.cn/aliyun-lc-upload/contest-config/biweekly-contest-155/contest_detail/card_img_497b.png","primary_color":"#3278FF","secondary_color":"#721BFF","background_colors":["#4fe3f8","#0e99d0"]},"questions":[{"id":8132,"question_id":3707,"credit":4,"title":"æ‰¾åˆ°æœ€å¸¸è§çš„å›ç­”","english_title":"Find the Most Common Response","title_slug":"find-the-most-common-response","category_slug":"algorithms","difficulty":2},{"id":8133,"question_id":3729,"credit":4,"title":"å•ä½è½¬æ¢ I","english_title":"Unit Conversion I","title_slug":"unit-conversion-i","category_slug":"algorithms","difficulty":2},{"id":8134,"question_id":3821,"credit":5,"title":"ç»Ÿè®¡æ°´å¹³å­ä¸²å’Œå‚ç›´å­ä¸²é‡å æ ¼å­çš„æ•°ç›®","english_title":"Count Cells in Overlapping Horizontal and Vertical Substrings","title_slug":"count-cells-in-overlapping-horizontal-and-vertical-substrings","category_slug":"algorithms","difficulty":2},{"id":8135,"question_id":3826,"credit":6,"title":"æœ‰å‘æ— ç¯å›¾ä¸­åˆæ³•æ‹“æ‰‘æ’åºçš„æœ€å¤§åˆ©æ¶¦","english_title":"Maximum Profit from Valid Topological Order in DAG","title_slug":"maximum-profit-from-valid-topological-order-in-dag","category_slug":"algorithms","difficulty":3}],"user_num":1503,"has_chosen_contact":true,"company":{"name":"","description":"","logo":null,"slug":""},"registered":true,"containsPremium":false,"current_timestamp":1747664236.121789,"unrated":false,"ranking_updated":true}
    """
    data = resp.json()
    contest = data.get("contest", {})
    questions = data.get("questions", [])

def get_contest_problem_info(contest_id: str, question_slug: str, cookie: str):
    # url = f"https://leetcode.cn/contest/{contest_id}/problems/{question_slug}/"
    # resp = requests.get(url, timeout=5, cookies={"LEETCODE_SESSION": cookie})
    with open("../dev/example_question.html", "r", encoding="utf-8") as f:
        text = f.read()
    soup = BeautifulSoup(text, "html.parser")
    code_info = soup.find("script", string=re.compile("var pageData ="))
    code_info_str = code_info.decode_contents()
    en_title = None
    question_example_testcases = []
    code_definitions = None
    for line in code_info_str.split("\n"):
        if "questionSourceTitle" in line:
            en_title = re.search(r"questionSourceTitle: '(.*?)'", line).group(1)
            continue
        if "questionExampleTestcases" in line:
            qet = re.search(r"questionExampleTestcases: '(.*)'", line).group(1)
            decoded_str = qet.encode('latin-1').decode('unicode_escape').split("\n")
            for s in decoded_str:
                question_example_testcases.append(json.loads(s))
            continue
        if "codeDefinition" in line:
            code_definitions = line.split(":", 1)[1].rsplit(",", 1)[0]
            # """ in decoded_str
            code_definitions = ast.literal_eval(code_definitions)
            continue

    print(code_definitions[3].get("defaultCode"))

    title = soup.find("h3")
    question_id = title.text.split(".")[0]

    cn_question_content = soup.find("div", class_="question-content default-content")
    if cn_question_content:
        cn_markdown_content = f"# {md(title.decode_contents())}\n\n{md(cn_question_content.decode_contents())}"
    else:
        print("No CN content found")
    en_question_content = soup.find("div", class_="question-content source-content")
    if en_question_content:
        en_markdown_content = f"# {question_id}. {en_title}\n\n{md(en_question_content.decode_contents())}"
    else:
        print("No EN content found")


if __name__ == "__main__":
    # dotenv.load_dotenv()
    # cke = os.getenv("COOKIE")
    # get_contest_info(contest_id="biweekly-contest-155", cookie=cke)
    # time.sleep(5)
    get_contest_problem_info(contest_id="biweekly-contest-155", question_slug="find-the-most-common-response", cookie="")
