import ast
import json
import os
import re
import time
import html
from bs4 import BeautifulSoup
from markdownify import markdownify as md

import dotenv
import requests


def get_contest_info(contest_id: str, cookie: str):
    url = f"https://leetcode.cn/contest/api/info/{contest_id}/"
    resp = requests.get(url, timeout=5, cookies={"LEETCODE_SESSION": cookie})
    """
    {"contest":{"id":1188,"title":"第 155 场双周赛","title_slug":"biweekly-contest-155","description":"<div>\n  <style>\n    .contest-information ol:not(.list-group) {\n      padding-left: 20px;\n    }\n\n    .contest-information ul:not(.list-group) {\n      padding-left: 20px;\n    }\n\n    .contest-information li:not(.list-group-item) {\n      margin-top: 5px;\n    }\n\n    .contest-information .list-group .list-group-item {\n      border: none;\n      margin-bottom: 1px;\n      display: flex;\n      flex-direction: row;\n      justify-content: space-between;\n    }\n\n    .contest-information .list-group .list-group-item > span {\n      flex: 0 0 auto;\n    }\n\n    .contest-information img[alt='LeetCoin'] {\n      position: relative;\n      top: -2px;\n    }\n\n    .contest-information .award-img {\n      display: block;\n      max-width: 600px;\n      width: 100%;\n      border-radius: 4px;\n    }\n\n    .contest-information .inner-banner {\n      margin: 30px 0 50px;\n      display: block;\n      max-width: 100%;\n      border-radius: 8px;\n    }\n\n    .contest-information ol p {\n      margin-top: 1em;\n      margin-bottom: 0.6em;\n    }\n\n    .contest-information ol {\n      list-style: auto;\n    }\n    .contest-information ul {\n      list-style: circle;\n    }\n  </style>\n\n  <div class=\"contest-information container\">\n    <div>\n      <div class=\"col-sm-8 col-md-9\">\n        <h3 class=\"text-300\">欢迎来到第 155 场双周赛</h3>\n        <br />\n        <p>\n          <strong>【本场奖励】</strong>\n        </p>\n\n        <ul>\n          <li><strong>排名第 1 - 10 名的参赛者</strong> 可获力扣电脑包 x1</li>\n          <li><strong>排名第 55、155、1024、1337、2048 名的参赛者</strong> 可获盲盒奖励 x1</li>\n        </ul>\n        <p style=\"border-color: var(--border-tertiary); border-left-width: 2px; padding-left: 1rem\">\n          <strong>本场竞赛奖品将于比赛后 20 个工作日</strong>\n          内进行发放，如遇不可抗力等情况，奖品可能延迟发货或发生调换，请关注力扣官方通知。<br />\n        </p>\n\n        <img class=\"inner-banner\" src=\"https://pic.leetcode.cn/1699241059-loeyWv-1760-360%20%E5%A5%96%E5%93%81.png\" />\n      <h4 class=\"text-300\">\n        <i class=\"fa fa-newspaper-o\" style=\"color: #1DA09C\" aria-hidden=\"true\"></i>\n        &nbsp;重要提示\n      </h4>\n        <ol>\n          <li>\n            力扣一向非常重视竞赛的公平和公正。为保障每一位参赛者的权益，给大家带来更好的竞赛体验，营造健康积极的竞赛环境，我们对竞赛规则进行了更详细的约定和规范，点击\n            <a class=\"text-sd-info\" href=\"https://support.leetcode.cn/hc/kb/article/1278066/\" target=\"_blank\"\n              >查看全部</a\n            >。\n          </li>\n          <li>请注意，每个错误提交的惩罚时间为 <b>5 分钟</b> 。</li>\n          <li>\n            为保障竞赛的公平性，力扣将在竞赛中隐藏部分用例。当参赛者在竞赛中提交未通过时，力扣不会显示给参赛者被隐藏的错误用例。\n          </li>\n          <li>本场竞赛的最终排名会在竞赛结束后的 5 个工作日内确认。</li>\n          <li>\n            <b>竞赛中的违规行为：</b>\n            <ul>\n              <li>一人使用多账号提交（力扣「中文社区 LCCN」和「美国网站 LCUS」账号属于两个账号）</li>\n              <li>多账号提交雷同代码（抄袭）</li>\n              <li>使用不正当手段影响他人竞赛的</li>\n              <li>竞赛结束前在讨论区发布答案的</li>\n              <li>\n                严禁使用任何代码生成工具或者外部辅助手段解题，包括但不限于将题目描述、测试用例或解题代码输入到外部辅助工具中的行为\n              </li>\n            </ul>\n            <p>\n              如有用户被检查出竞赛中存在违规行为，力扣会坚持以 🙅 零容忍 的态度维护竞赛的 ⚖️\n              公平、公正，严格按照以下处罚规则执行：\n            </p>\n            <ul>\n              <li>第一次违规：❗️ 账号内的所有积分清零，账号冻结 1 个月</li>\n              <li>第二次违规：🚫 永久封号</li>\n            </ul>\n            <p>同时我们也鼓励大家共同维护竞赛的公平和公正，我们会给于举报成功的用户额外的奖励：</p>\n            <ul>\n              <li>被认定为违规账号的前 10 名举报者，每人可获得 20 积分奖励</li>\n              <li>每人每场最高可获得举报成功的 100 积分奖励</li>\n            </ul>\n          </li>\n          <p>\n            另外，为了保证竞赛的公正、公平，请勿在竞赛结束前在讨论区发布、讨论可能会影响竞赛正常进行的内容，包括且不限于发布竞赛题答案、解题思路、方法、提醒注意等，社区管理员将有权根据实际情况予以警告、删除、禁言、封禁其相应帐号的功能，情节严重者，将酌情封禁对应\n            IP。\n          </p>\n        </ol>\n        <br />\n        <br />\n      <h4 class=\"text-300\">\n        <i class=\"fa fa-bullhorn\" style=\"color: #FEA116\" aria-hidden=\"true\"></i>\n        &nbsp;通知\n      </h4>\n        <p>\n          您必须先\n          <b class=\"text-sd-brand-lc-orange\">报名</b> 后方能参加该场竞赛。我们祝愿您参赛愉快！\n        </p>\n        <br />\n\n        \n            <a href=\"/discuss/post/3662926/di-155-chang-shuang-zhou-sai-by-leetcode-0p0b\" target=\"_blank\">\n                <img\n                    src=\"https://assets.leetcode.cn/aliyun-lc-upload/contest-config/discuss/contest_to_discuss_image.png\"\n                    style=\"width:320px; border-radius: 10px; margin: 10px 0;\"\n                />\n            </a>\n        \n      </div>\n      <div class=\"col-sm-4 col-md-3\">\n      <h3 class=\"text-300\">\n        <i class=\"fa fa-trophy text-orange\" aria-hidden=\"true\"></i>\n        &nbsp;竞赛奖励\n      </h3>\n        <ul class=\"list-group whitespace-nowrap\" style=\"margin-top: 20px; min-width: 250px\">\n          <li class=\"list-group-item\">\n            <b>第一名</b>\n            <span>\n              5,000\n              <a href=\"/points/\" target=\"_blank\">\n                <img\n                  src=\"https://static.leetcode-cn.com/cn-legacy-assets/images/LeetCoin.png\"\n                  height=\"15px\"\n                  alt=\"LeetCoin\"\n                />\n              </a>\n            </span>\n          </li>\n          <li class=\"list-group-item\">\n            <b>第二名</b>\n            <span>\n              2,500\n              <a href=\"/points/\" target=\"_blank\">\n                <img\n                  src=\"https://static.leetcode-cn.com/cn-legacy-assets/images/LeetCoin.png\"\n                  height=\"15px\"\n                  alt=\"LeetCoin\"\n                />\n              </a>\n            </span>\n          </li>\n          <li class=\"list-group-item\">\n            <b>第三名</b>\n            <span>\n              1,500\n              <a href=\"/points/\" target=\"_blank\">\n                <img\n                  src=\"https://static.leetcode-cn.com/cn-legacy-assets/images/LeetCoin.png\"\n                  height=\"15px\"\n                  alt=\"LeetCoin\"\n                />\n              </a>\n            </span>\n          </li>\n          <li class=\"list-group-item\">\n            <b>4 - 10 名</b>\n            <span>\n              800\n              <a href=\"/points/\" target=\"_blank\">\n                <img\n                  src=\"https://static.leetcode-cn.com/cn-legacy-assets/images/LeetCoin.png\"\n                  height=\"15px\"\n                  alt=\"LeetCoin\"\n                />\n              </a>\n            </span>\n          </li>\n          <li class=\"list-group-item\">\n            <b>11 - 50 名</b>\n            <span>\n              300\n              <a href=\"/points/\" target=\"_blank\">\n                <img\n                  src=\"https://static.leetcode-cn.com/cn-legacy-assets/images/LeetCoin.png\"\n                  height=\"15px\"\n                  alt=\"LeetCoin\"\n                />\n              </a>\n            </span>\n          </li>\n          <li class=\"list-group-item\">\n            <b>51 - 100 名</b>\n            <span>\n              100\n              <a href=\"/points/\" target=\"_blank\">\n                <img\n                  src=\"https://static.leetcode-cn.com/cn-legacy-assets/images/LeetCoin.png\"\n                  height=\"15px\"\n                  alt=\"LeetCoin\"\n                />\n              </a>\n            </span>\n          </li>\n          <li class=\"list-group-item\">\n            <b>101 - 200 名</b>\n            <span>\n              50\n              <a href=\"/points/\" target=\"_blank\">\n                <img\n                  src=\"https://static.leetcode-cn.com/cn-legacy-assets/images/LeetCoin.png\"\n                  height=\"15px\"\n                  alt=\"LeetCoin\"\n                />\n              </a>\n            </span>\n          </li>\n          <li class=\"list-group-item\">\n            <b>重在参与奖励</b>\n            <span>\n              5\n              <a href=\"/points/\" target=\"_blank\">\n                <img\n                  src=\"https://static.leetcode-cn.com/cn-legacy-assets/images/LeetCoin.png\"\n                  height=\"15px\"\n                  alt=\"LeetCoin\"\n                />\n              </a>\n            </span>\n          </li>\n          <li class=\"list-group-item\">\n            <b>首次参加比赛并成功提交</b>\n            <span>\n              200\n              <a href=\"/points/\" target=\"_blank\">\n                <img\n                  src=\"https://static.leetcode-cn.com/cn-legacy-assets/images/LeetCoin.png\"\n                  height=\"15px\"\n                  alt=\"LeetCoin\"\n                />\n              </a>\n            </span>\n          </li>\n          <li class=\"list-group-item\">\n            <b>一周同时参加双周赛和周赛</b>\n            <span>\n              66\n              <a href=\"/points/\" target=\"_blank\">\n                <img\n                  src=\"https://static.leetcode-cn.com/cn-legacy-assets/images/LeetCoin.png\"\n                  height=\"15px\"\n                  alt=\"LeetCoin\"\n                />\n              </a>\n            </span>\n          </li>\n        </ul>\n      <h4 class=\"text-300\">\n        <i class=\"fa fa-star text-yellow\" aria-hidden=\"true\"></i>\n        &nbsp;追加奖励 - 全球排名\n      </h4>\n        <ul class=\"list-group whitespace-nowrap\" style=\"margin-top: 20px\">\n          <li class=\"list-group-item\">\n            <b>全球排名前 10</b>\n            <span>\n              500\n              <a href=\"/points/\" target=\"_blank\">\n                <img\n                  src=\"https://static.leetcode-cn.com/cn-legacy-assets/images/LeetCoin.png\"\n                  height=\"15px\"\n                  alt=\"LeetCoin\"\n                />\n              </a>\n            </span>\n          </li>\n          <li class=\"list-group-item\">\n            <b>全球排名 11 - 20</b>\n            <span>\n              300\n              <a href=\"/points/\" target=\"_blank\">\n                <img\n                  src=\"https://static.leetcode-cn.com/cn-legacy-assets/images/LeetCoin.png\"\n                  height=\"15px\"\n                  alt=\"LeetCoin\"\n                />\n              </a>\n            </span>\n          </li>\n          <li class=\"list-group-item\">\n            <b>全球排名 21 - 50</b>\n            <span>\n              100\n              <a href=\"/points/\" target=\"_blank\">\n                <img\n                  src=\"https://static.leetcode-cn.com/cn-legacy-assets/images/LeetCoin.png\"\n                  height=\"15px\"\n                  alt=\"LeetCoin\"\n                />\n              </a>\n            </span>\n          </li>\n          <li class=\"list-group-item\">\n            <b>全球排名 51 - 100</b>\n            <span>\n              50\n              <a href=\"/points/\" target=\"_blank\">\n                <img\n                  src=\"https://static.leetcode-cn.com/cn-legacy-assets/images/LeetCoin.png\"\n                  height=\"15px\"\n                  alt=\"LeetCoin\"\n                />\n              </a>\n            </span>\n          </li>\n        </ul>\n      </div>\n    </div>\n  </div>\n  <hr />\n  <p>\n    <b\n      >想让力扣社区的百万极客们 <i>认识您的公司</i> 吗？ 那就赶快\n      <a class=\"text-sd-info\" href=\"https://support.leetcode.cn/hc/request/new/\" target=\"_blank\">联系我们</a>\n      ，即有可能赞助我们的下一场竞赛哦！</b\n    >\n  </p>\n</div>\n","duration":5400,"start_time":1747663571,"is_virtual":true,"origin_start_time":1745677800,"is_private":false,"related_contest_title":null,"is_ee_exam_contest":false,"card_img":"https://assets.leetcode.cn/aliyun-lc-upload/contest-config/biweekly-contest-155/contest_detail/card_img_497b.png","primary_color":"#3278FF","secondary_color":"#721BFF","background_colors":["#4fe3f8","#0e99d0"]},"questions":[{"id":8132,"question_id":3707,"credit":4,"title":"找到最常见的回答","english_title":"Find the Most Common Response","title_slug":"find-the-most-common-response","category_slug":"algorithms","difficulty":2},{"id":8133,"question_id":3729,"credit":4,"title":"单位转换 I","english_title":"Unit Conversion I","title_slug":"unit-conversion-i","category_slug":"algorithms","difficulty":2},{"id":8134,"question_id":3821,"credit":5,"title":"统计水平子串和垂直子串重叠格子的数目","english_title":"Count Cells in Overlapping Horizontal and Vertical Substrings","title_slug":"count-cells-in-overlapping-horizontal-and-vertical-substrings","category_slug":"algorithms","difficulty":2},{"id":8135,"question_id":3826,"credit":6,"title":"有向无环图中合法拓扑排序的最大利润","english_title":"Maximum Profit from Valid Topological Order in DAG","title_slug":"maximum-profit-from-valid-topological-order-in-dag","category_slug":"algorithms","difficulty":3}],"user_num":1503,"has_chosen_contact":true,"company":{"name":"","description":"","logo":null,"slug":""},"registered":true,"containsPremium":false,"current_timestamp":1747664236.121789,"unrated":false,"ranking_updated":true}
    """
    data = resp.json()
    contest = data.get("contest", {})
    questions = data.get("questions", [])

def get_contest_problem_info(contest_id: str, question_slug: str, cookie: str):
    # url = f"https://leetcode.cn/contest/{contest_id}/problems/{question_slug}/"
    # resp = requests.get(url, timeout=5, cookies={"LEETCODE_SESSION": cookie})
    with open("../dev/example_question.html", "r", encoding="utf-8") as f:
        text = f.read()
    soup = BeautifulSoup(text, "html.parser")
    code_info = soup.find("script", string=re.compile("var pageData ="))
    code_info_str = code_info.decode_contents()
    en_title = None
    question_example_testcases = []
    code_definitions = None
    for line in code_info_str.split("\n"):
        if "questionSourceTitle" in line:
            en_title = re.search(r"questionSourceTitle: '(.*?)'", line).group(1)
            continue
        if "questionExampleTestcases" in line:
            qet = re.search(r"questionExampleTestcases: '(.*)'", line).group(1)
            decoded_str = qet.encode('latin-1').decode('unicode_escape').split("\n")
            for s in decoded_str:
                question_example_testcases.append(json.loads(s))
            continue
        if "codeDefinition" in line:
            code_definitions = line.split(":", 1)[1].rsplit(",", 1)[0]
            # """ in decoded_str
            code_definitions = ast.literal_eval(code_definitions)
            continue

    print(code_definitions[3].get("defaultCode"))

    title = soup.find("h3")
    question_id = title.text.split(".")[0]

    cn_question_content = soup.find("div", class_="question-content default-content")
    if cn_question_content:
        cn_markdown_content = f"# {md(title.decode_contents())}\n\n{md(cn_question_content.decode_contents())}"
    else:
        print("No CN content found")
    en_question_content = soup.find("div", class_="question-content source-content")
    if en_question_content:
        en_markdown_content = f"# {question_id}. {en_title}\n\n{md(en_question_content.decode_contents())}"
    else:
        print("No EN content found")


if __name__ == "__main__":
    # dotenv.load_dotenv()
    # cke = os.getenv("COOKIE")
    # get_contest_info(contest_id="biweekly-contest-155", cookie=cke)
    # time.sleep(5)
    get_contest_problem_info(contest_id="biweekly-contest-155", question_slug="find-the-most-common-response", cookie="")
